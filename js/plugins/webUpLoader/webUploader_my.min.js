define(function(require,a,t){var i={init:function(){require([cdnDomain+"/js/plugins/webUpLoader/js/webuploader.js"],function(e){if(Mom.include("myCss_webUpLoader",cdnDomain,["js/plugins/webUpLoader/css/webuploader_my.css"]),!e.Uploader.support())throw alert("WebUploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器"),new Error("WebUploader does not support the browser you are using.");$("#relateId").val(Mom.getUrlParam("relateId")||"");var a,t=$("#uploader"),i=$('<ul class="filelist"></ul>').appendTo(t.find(".queueList")),s=t.find(".statusBar"),n=s.find(".info"),r=t.find(".uploadBtn"),o=t.find(".placeholder"),l=s.find(".progress").hide(),d=0,c=0,p=window.devicePixelRatio||1,u=110*p,m=110*p,f="pedding",h={},v=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a},g=!0,b=[],k=function(t,p){function k(e){var a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),t=$('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(a),s=a.find("p.progress span"),n=a.find("p.imgWrap"),r=$('<p class="error"></p>'),o=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}r.text(text).appendTo(a)};"invalid"===e.getStatus()?o(e.statusText):(n.text("预览中"),I.makeThumb(e,function(e,a){if(e)n.text("不能预览");else{var t=$('<img src="'+a+'">');n.empty().append(t)}},u,m),h[e.id]=[e.size,0],e.rotation=0),e.on("statuschange",function(t,i){"progress"===i&&s.hide().width(0),"error"===t||"invalid"===t?(o(e.statusText),h[e.id][1]=1):"interrupt"===t?o("interrupt"):"queued"===t?h[e.id][1]=0:"progress"===t&&(r.remove(),s.css("display","block")),a.removeClass("state-"+i).addClass("state-"+t)}),a.on("mouseenter",function(){t.stop().animate({height:30})}),a.on("mouseleave",function(){t.stop().animate({height:0})}),t.on("click","span",function(){var a,t=$(this).index();switch(t){case 0:return void I.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}v?(a="rotate("+e.rotation+"deg)",n.css({"-webkit-transform":a,"-mos-transform":a,"-o-transform":a,transform:a})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),a.appendTo(i)}function w(){var e,a=0,t=0,i=l.children();$.each(h,function(e,i){t+=i[0],a+=i[0]*i[1]}),e=t?a/t:0,i.eq(0).text(Math.round(100*e)+"%"),i.eq(1).css("width",Math.round(100*e)+"%"),y()}function y(){var a,t="";"ready"===f?t="选中"+d+"个文件，共"+e.formatSize(c)+"。":"confirm"===f?(a=I.getStats(),a.uploadFailNum&&(t="已成功上传"+a.successNum+"张照片至XX相册，"+a.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>')):(a=I.getStats(),t="共"+d+"个文件（"+e.formatSize(c)+"），已上传"+a.successNum+"个文件",a.uploadFailNum&&(t+="，失败"+a.uploadFailNum+"个文件")),n.html(t)}function x(e){var a;if(e!==f){switch(r.removeClass("state-"+f),r.addClass("state-"+e),f=e,f){case"pedding":o.removeClass("element-invisible"),i.parent().removeClass("filled"),i.hide(),s.addClass("element-invisible"),I.refresh();break;case"ready":o.addClass("element-invisible"),$("#filePicker2").removeClass("element-invisible"),i.parent().addClass("filled"),i.show(),s.removeClass("element-invisible"),I.refresh();break;case"uploading":$("#filePicker2").addClass("element-invisible"),l.show(),r.text("暂停上传");break;case"paused":l.show(),r.text("继续上传");break;case"confirm":if(l.hide(),r.text("开始上传").addClass("disabled"),a=I.getStats(),a.successNum&&!a.uploadFailNum)return void x("finish");break;case"finish":a=I.getStats(),a.successNum?alert("上传成功"):(f="done",location.reload())}y()}}var C={pick:{id:"#filePicker",innerHTML:"请选择",multiple:!0},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Files",extensions:"gif,jpg,jpeg,bmp,png,pdf,doc,docx,txt,xls,xlsx,ppt,pptx,zip,mp3,mp4,text,csv",mimeTypes:"image/jpg,image/jpeg,image/png,text/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/pdf,application/zip,application/csv"},swf:Const.admin+"/js/plugins/webUploader/Uploader.swf",disableGlobalDnd:!0,server:t,fileNumLimit:10,fileSingleSizeLimit:20971520,threads:1,compress:!1,auto:!1,chunked:!1,chunkSize:5242880,chunkRetry:2},S=$.extend(!0,{},C,p||{});0==S.auto&&$("#uploadBtn").removeClass("hidden");var I=e.create(S);S.pick.multiple&&($("#filePicker2").removeClass("hidden"),I.addButton({id:"#filePicker2",label:"继续添加"})),I.on("all",function(e,a,t,i){switch(e){case"ready":case"beforeFileQueued":break;case"fileQueued":M(a);break;case"filesQueued":A(a);break;case"uploadBeforeSend":E(a,t,i),p.uploadBeforeSend&&p.uploadBeforeSend(a,t,i);break;case"uploadProgress":L(a,t);break;case"uploadSuccess":U(a,t);break;case"uploadFinished":T(a),A(a);break;case"fileDequeued":D(a);break;case"error":_(a,t,i);break;default:return}});var E=function(e,a,t){a.relateId=$("#relateId").val(),a.module=S.module||"",t.Accept="application/json; charset=utf-8",t.Authorization=Mom.getAuthInfo()},L=function(e,t){var i=$("#"+e.id),s=i.find(".progress span");s.length?(s.css({width:100*t+"%"}),h[e.id][1]=t,w()):a||(a=Mom.layLoading("数据处理中...."))},M=function(e){function a(){d++,c+=e.size,1===d&&(o.addClass("element-invisible"),s.show()),k(e),x("ready"),w()}g&&""==$("#relateId").val()?($("#uploadBtn").addClass("disabled"),g=!1,Api.ajaxForm(Const.admin+"/Common/uuid",{},function(e){e.success?($("#uploadBtn").removeClass("disabled"),$("#relateId").val(e.message),a()):Mom.layAlert(e.message)})):a()},_=function(e,a,t){function i(e){var a="";a=e<102.4?e.toFixed(2)+"B":e<104857.6?(e/1024).toFixed(2)+"KB":e<107374182.4?(e/1048576).toFixed(2)+"MB":(e/1073741824).toFixed(2)+"GB";var t=a+"",i=t.indexOf("."),s=t.substr(i+1,2);return"00"==s?t.substring(0,i)+t.substr(i+3,2):t}var s=t||a,n=s.name,r="";switch(e){case"F_DUPLICATE":r=n+"文件重复",b.push(r);break;case"Q_TYPE_DENIED":r=n+"文件类型 不允许",b.push(r);break;case"F_EXCEED_SIZE":var o=i(S.fileSingleSizeLimit);r=n+"文件大小不可超过"+o,b.push(r);break;case"Q_EXCEED_SIZE_LIMIT":b.push("超出空间文件大小");break;case"Q_EXCEED_NUM_LIMIT":b.push("抱歉，单次上传数量不可超过"+S.fileNumLimit+"个");break;default:r=n+" Error:"+e}},A=function(e){b.length>0&&alert(b.join("\n")),b=[]},D=function(e){d--,c-=e.size,d||x("pedding");var a=$("#"+e.id);delete h[e.id],a.off().find(".file-panel").off().end().remove(),w()},U=function(e,a){if(1==a.success){$("#"+e.id).append('<span class="success"></span>'),$("#"+e.id).off("mouseenter mouseleave"),$("#"+e.id).find(".file-panel").remove();var t=a.SysArchive;$("#"+e.id).attr("attr-fileId",t.id).attr("attr-fileName",t.fileName).attr("attr-docName",t.docName).attr("attr-type",t.type).attr("attr-size",t.size).attr("attr-success","1")}else $("#"+e.id).append('<p class="error">上传失败</p>'),Mom.layAlert(a.message)},T=function(e){$("#okBtn").removeClass("hidden"),a&&(layer.close(a),a="")};$(".uploadBtn").on("click",function(){if($(this).hasClass("disabled"))return!1;"ready"===f?I.upload():"paused"===f?I.upload():"uploading"===f&&I.stop()})},w=setInterval(function(){serverUrl&&(k(serverUrl,optionsParam),clearInterval(w))},500)})},webUploaderSingle:function(e,a,t){require([cdnDomain+"/js/plugins/webUpLoader/js/webuploader.js"],function(i){if(!i.Uploader.support())throw alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器"),new Error("WebUploader does not support the browser you are using.");var s=[],n=function(){var n={pick:{id:e,multiple:!1},accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/jpg,image/jpeg,image/png"},swf:Const.admin+"/js/plugins/webUploader/Uploader.swf",disableGlobalDnd:!0,server:Const.admin+"/api/imp/sys/SysArchive/upload",fileNumLimit:1,fileSingleSizeLimit:20971520,compress:!1,auto:!0,duplicate:!0,chunked:!1,chunkSize:5242880,chunkRetry:2},r=$.extend(!0,{},n,a||{}),o=i.create(r);o.on("all",function(e,t,i,s){switch(e){case"ready":case"beforeFileQueued":break;case"fileQueued":p(t);break;case"uploadBeforeSend":d(t,i,s),a.uploadBeforeSend&&a.uploadBeforeSend(t,i,s);break;case"uploadProgress":c(t,i);break;case"uploadSuccess":f(t,i);break;case"uploadComplete":h(t),m(t);break;case"fileDequeued":break;case"error":u(t,i,s);break;default:return}});var l,d=function(e,a,t){a.relateId=r.relateId||"",a.module=r.module||"",a.multiple=r.pick.multiple,t.Accept="application/json; charset=utf-8",t.Authorization=Mom.getAuthInfo()},c=function(e,a){var t=$("#"+e.id),i=t.find(".progress span");i.length?(i.css({width:100*a+"%"}),percentages[e.id][1]=a,updateTotalProgress()):l||(l=Mom.layLoading("处理中，请稍后...."))},p=function(e){},u=function(e,a,t){function i(e){var a="";a=e<102.4?e.toFixed(2)+"B":e<104857.6?(e/1024).toFixed(2)+"KB":e<107374182.4?(e/1048576).toFixed(2)+"MB":(e/1073741824).toFixed(2)+"GB";var t=a+"",i=t.indexOf("."),s=t.substr(i+1,2);return"00"==s?t.substring(0,i)+t.substr(i+3,2):t}var n=t||a,o=n.name,l="";switch(e){case"F_DUPLICATE":l=o+"文件重复",s.push(l);break;case"Q_TYPE_DENIED":l=o+"文件类型 不允许",s.push(l);break;case"F_EXCEED_SIZE":var d=i(r.fileSingleSizeLimit);l=o+"文件大小不可超过"+d,s.push(l);break;case"Q_EXCEED_SIZE_LIMIT":s.push("超出空间文件大小");break;case"Q_EXCEED_NUM_LIMIT":s.push("抱歉，单次上传数量不可超过"+r.fileNumLimit+"个");break;default:l=o+" Error:"+e}m()},m=function(e){s.length>0&&alert(s.join("\n")),s=[]},f=function(e,a){t&&t(o,e,a),0==a.success&&Mom.layAlert(a.message)},h=function(e){o.reset(),l&&(layer.close(l),l="")};return o};n()})},openWebuploaderWin:function(e,a,t,s){t=t||{};var n=Const.admin+"/api/imp/sys/SysArchive/upload",r=$(a).val(),o={type:2,skin:Const.layerSkin()||"",maxmin:!0,title:"文件上传",area:["800px","410px"],content:cdnDomain+"/pages/common/webUploadWin.html?relateId="+r,success:function(r,o){var l=r.find("iframe")[0].contentWindow;l.setConfig(n,t),$("#okBtn",l.document).click(function(){var n=[],r=[],d=!1;$(".filelist",l.document).each(function(e,a){$(a).children("li").each(function(e,a){var t=$(a).attr("attr-success")||"0",i={id:$(a).attr("attr-fileId"),fileName:$(a).attr("attr-fileName"),docName:$(a).attr("attr-docName"),type:$(a).attr("attr-type"),size:$(a).attr("attr-size"),thumb:$(a).find("img").attr("src")};"1"==t?(n.push(i),d=!0):r.push(i)})});var c=!0,p=$("#relateId",l.document).val();if(s)c=s({success:d,relateId:p,rows:n,errorFiles:r});else if(d){$(a).val(p);var u={canDelete:!0,templeteUrl:t.templeteUrl};i.renderArchiveListDefault(e,n,u)}0!=c&&Mom.top().layer.close(o)})}};return Mom.top().layer.open(o)},renderArchiveList:function(e,a,t,s){t=t||{},Api.ajaxJson(Const.admin+"/api/imp/sys/SysArchive/list",JSON.stringify(a),function(a){a.success?i.renderArchiveListDefault(e,a.rows,t,s):Mom.layAlert(a.message)})},renderArchiveListDefault:function(e,a,t,i){var s=$(e).children(".nodata");a&&0<a.length?s.remove():0!=t.showNodata&&(s.length?s.css({display:"block"}):$(e).html("<p class='nodata center'>暂无附件</p>")),$(a).each(function(e,a){var t=Bus.getAttaType(a.type);a.icon="fileico_"+t}),null!=e&&require(["artTemplate"],function(s){var n=t.templeteUrl||cdnDomain+"/pages/common/attachmentViewTemp.html";n.toLowerCase().indexOf("http")<0&&(n=Mom.basePath+n),$.get(n,function(n){var r=s.compile(n),o=r({rows:a});$(e).append(o),$(e).find(".file-delete").unbind("click").click(function(){if(1==t.canDelete){var e=this,a={ids:$(this).closest("li").attr("data-id")};Bus.deleteItem("确认删除吗",Const.admin+"/api/imp/sys/SysArchive/delete",a,function(a,t,s){return i?i(a,t,s):(1==a.success?($(e).closest("li").remove(),Mom.top().layer.close(t)):Mom.layAlert(a.message),!0)})}else Mom.layMsg("当前不能删除")}),$(e).find(".file-download").unbind("click").click(function(){if(0!=t.canDownload){var e={id:$(this).closest("li").attr("data-id"),__noauth:!0};Bus.windowOpenPost(Const.admin+"/api/imp/sys/SysArchive/download",e)}else Mom.layMsg("当前不能下载")}),$(e).find(".file-browse").unbind("click").click(function(){var e=$(this).attr("data-fileType").split("_")[1],a=$(this).closest("li"),i=a.attr("data-id"),s=a.attr("title");if("image"==e){var n=[{alt:s,pid:i,anim:5,src:Const.admin+"/api/imp/sys/SysArchive/download?id="+i+"&__noauth=true"}];Mom.top().showPhotos(n)}else{var r=Const.admin+"/api/imp/sys/SysArchive/download?id="+i+"&__noauth=true",o=r+"&fullfilename="+s,l=t.previewServer||Const.previewServer;window.open(l+"/onlinePreview?url="+encodeURIComponent(o))}})})})}};return{init:i.init,webUploaderSingle:i.webUploaderSingle,openWebuploaderWin:i.openWebuploaderWin,renderArchiveList:i.renderArchiveList,renderArchiveListDefault:i.renderArchiveListDefault}});