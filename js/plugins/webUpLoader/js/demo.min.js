jQuery(function(){var g=jQuery,n=g("#uploader"),i=g('<ul class="filelist"></ul>').appendTo(n.find(".queueList")),s=n.find(".statusBar"),c=s.find(".info"),b=n.find(".uploadBtn"),f=n.find(".placeholder"),m=s.find(".progress").hide(),u=0,l=0,j=window.devicePixelRatio||1,k=110*j,a=110*j,h="pedding",v={},r=(function(){var w=document.createElement("p").style,x="transition" in w||"WebkitTransition" in w||"MozTransition" in w||"msTransition" in w||"OTransition" in w;w=null;return x})(),p;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}p=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},swf:BASE_URL+"/js/Uploader.swf",disableGlobalDnd:true,chunked:true,server:"http://mom.tunnel.qydev.com/admin-api/api/img/sys/SysUpload/upimg?imgPath=img",fileNumLimit:300,fileSizeLimit:5*1024*1024,fileSingleSizeLimit:1*1024*1024});p.addButton({id:"#filePicker2",label:"继续添加"});function q(B){var C=g('<li id="'+B.id+'"><p class="title">'+B.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),z=g('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(C),y=C.find("p.progress span"),x=C.find("p.imgWrap"),A=g('<p class="error"></p>'),w=function(D){switch(D){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}A.text(text).appendTo(C)};if(B.getStatus()==="invalid"){w(B.statusText)}else{x.text("预览中");p.makeThumb(B,function(E,F){if(E){x.text("不能预览");return}var D=g('<img src="'+F+'">');x.empty().append(D)},k,a);v[B.id]=[B.size,0];B.rotation=0}B.on("statuschange",function(E,D){if(D==="progress"){y.hide().width(0)}else{if(D==="queued"){C.off("mouseenter mouseleave");z.remove()}}if(E==="error"||E==="invalid"){console.log(B.statusText);w(B.statusText);v[B.id][1]=1}else{if(E==="interrupt"){w("interrupt")}else{if(E==="queued"){v[B.id][1]=0}else{if(E==="progress"){A.remove();y.css("display","block")}else{if(E==="complete"){C.append('<span class="success"></span>')}}}}}C.removeClass("state-"+D).addClass("state-"+E)});C.on("mouseenter",function(){z.stop().animate({height:30})});C.on("mouseleave",function(){z.stop().animate({height:0})});z.on("click","span",function(){var D=g(this).index(),E;switch(D){case 0:p.removeFile(B);return;case 1:B.rotation+=90;break;case 2:B.rotation-=90;break}if(r){E="rotate("+B.rotation+"deg)";x.css({"-webkit-transform":E,"-mos-transform":E,"-o-transform":E,transform:E})}else{x.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((B.rotation/90)%4+4)%4)+")")}});C.appendTo(i)}function t(w){var x=g("#"+w.id);delete v[w.id];d();x.off().find(".file-panel").off().end().remove()}function d(){var w=0,z=0,x=m.children(),y;g.each(v,function(B,A){z+=A[0];w+=A[0]*A[1]});y=z?w/z:0;x.eq(0).text(Math.round(y*100)+"%");x.eq(1).css("width",Math.round(y*100)+"%");e()}function e(){var x="",w;if(h==="ready"){x="选中"+u+"张图片，共"+WebUploader.formatSize(l)+"。"}else{if(h==="confirm"){w=p.getStats();if(w.uploadFailNum){x="已成功上传"+w.successNum+"张照片至XX相册，"+w.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{w=p.getStats();x="共"+u+"张（"+WebUploader.formatSize(l)+"），已上传"+w.successNum+"张";if(w.uploadFailNum){x+="，失败"+w.uploadFailNum+"张"}}}c.html(x)}function o(y){var x,w;if(y===h){return}b.removeClass("state-"+h);b.addClass("state-"+y);h=y;switch(h){case"pedding":f.removeClass("element-invisible");i.parent().removeClass("filled");i.hide();s.addClass("element-invisible");p.refresh();break;case"ready":f.addClass("element-invisible");g("#filePicker2").removeClass("element-invisible");i.parent().addClass("filled");i.show();s.removeClass("element-invisible");p.refresh();break;case"uploading":g("#filePicker2").addClass("element-invisible");m.show();b.text("暂停上传");break;case"paused":m.show();b.text("继续上传");break;case"confirm":m.hide();b.text("开始上传").addClass("disabled");w=p.getStats();if(w.successNum&&!w.uploadFailNum){o("finish");return}break;case"finish":w=p.getStats();if(w.successNum){alert("上传成功")}else{h="done";location.reload()}break}e()}p.onUploadProgress=function(y,w){var z=g("#"+y.id),x=z.find(".progress span");x.css("width",w*100+"%");v[y.id][1]=w;d()};p.onFileQueued=function(w){u++;l+=w.size;if(u===1){f.addClass("element-invisible");s.show()}q(w);o("ready");d()};p.onFileDequeued=function(w){u--;l-=w.size;if(!u){o("pedding")}t(w);d()};p.on("all",function(x){var w;switch(x){case"uploadFinished":o("confirm");break;case"startUpload":o("uploading");break;case"stopUpload":o("paused");break}});p.onError=function(w){alert("Eroor: "+w)};b.on("click",function(){if(g(this).hasClass("disabled")){return false}if(h==="ready"){p.upload()}else{if(h==="paused"){p.upload()}else{if(h==="uploading"){p.stop()}}}});c.on("click",".retry",function(){p.retry()});c.on("click",".ignore",function(){alert("todo")});b.addClass("state-"+h);d()});