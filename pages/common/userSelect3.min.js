require([cdnDomain+"/js/zlib/app.js"],function(e){var n=Mom.getUrlParam("multiple")||"false",t=Mom.getUrlParam("showSearch")||"true";"true"!=t&&$("#has_searchText").parent().hide(),require(["ztree_my"],function(e){function t(){Api["ajax"+w](b.url,A,function(e){e.success?r(e.rows):Mom.layAlert(e.message)})}function r(n){var t=new e;m=t.loadData($("#officeTree"),n,!1,T),t.registerSearch(m,$("#org_searchText"),"name")}function a(e,n,t,r){m&&(p=t,m.expandNode(t),o())}function o(){var e={};if(p){var n=p,t=p.id;e="1"==n.type?{companyId:t}:{deptId:t};var r=waitUserOptions.apiCfg||{},a=r.contentType||"Json",o=e||r.data||{},i="Json"==a?JSON.stringify(o):o;Api["ajax"+a](r.url,i,function(e){if(e.success){var n=e.rows;p&&$.each(n,function(e,n){n.orgId=p.id,n.nameLabel=n.name}),s(n)}else Mom.layAlert(e.message)})}}function s(n){var t=new e,r=[];y.getNodes()&&$.each(y.getNodes(),function(e,n){r.push(n.id)});var a=[];$.each(n,function(e,n){$.inArray(n.id,r)<0&&a.push(n)}),v=t.loadData($("#userTree"),a,!1,M),t.registerSearch(v,$("#wait_searchText"),"name"),c()}function i(e,t,r,a){if(r){var o=y.transformToArray(y.getNodes());if("true"!=n&&o&&o.length>0)return Mom.layMsg("只能选择一个用户"),!1;var s=[];if($.each(o,function(e,n){s.push(n.id)}),$.inArray(r.id,s)>-1)return!1;var i=v.transformToArray(v.getNodes());return v.removeNode(r),y.addNodes(null,r),o.push(r),h(i.length-1,"#userTree"),h(o.length,"#selectedTree"),!0}}function l(e,n,t,r,a){if(null==t&&n.length>0)for(var o=0;o<n.length;o++)i(null,e,n[o]);return!1}function c(){$(".selectAll").unbind("click").bind("click",function(){var e=[],n=v.getNodes();$.each(n,function(n,t){null!=t.isHidden&&0!=t.isHidden||e.push(t)});var t=e.length;t>0&&Mom.layConfirm("确定将（"+t+"）个用户添加到已选列表中吗?",function(n,r){for(var a=0;a<t;a++)i(null,"userTree",e[a]);return!0})})}function u(e){var n=[];if(C&&""!=C){if("[object Array]"===Object.prototype.toString.call(C))n=C;else if("object"==typeof C)C.id&&(n=[C]);else{var r=C.split(",");$.each(r,function(e,t){n.push({id:t,name:t})})}d(n),1==e&&t()}O.url&&""!=O.url?Api["ajax"+J](O.url,A,function(n){n.success?d(n.rows):Mom.layAlert(n.message),1==e&&t()}):0==n.length&&(d([]),1==e&&t())}function d(n){var t=[];if($.each(n,function(e,n){t.push({id:n.id,name:n.name,nameLabel:"<font color='red'>"+n.name+"</font>"}),k.push(n)}),y)y.addNodes(null,t),h(t.length,"#selectedTree");else{var r=new e;y=r.loadData($("#selectedTree"),t,!1,x),r.registerSearch(y,$("#has_searchText"),"name")}g()}function f(e,n,t,r){if(t){if(v){(p&&t.orgId==p.id||null==t.orgId)&&v.addNodes(null,[t]);var a=v.transformToArray(v.getNodes());h(a.length,"#userTree")}y.removeNode(t);var o=y.transformToArray(y.getNodes());h(o.length,"#selectedTree")}}function g(){$(".hasRevertBtn").unbind("click").bind("click",function(){Mom.layConfirm("所做的人员调整将被还原<br>确定继续吗?",function(e,n){var t=y.transformToArray(y.getNodes());return $.each(t,function(e,n){y.removeNode(n)}),u(!1),o(),!0})})}function h(e,n){e>0?$(n).find(".nodata").hide():$(n).find(".nodata").show()}var m,p,v,y,T=$.extend(!0,{},{callback:{onClick:a}},orgOptions.settting||{}),b=orgOptions.apiCfg||{},w=b.contentType||"Json",N=b.data||{},A="Json"==w?JSON.stringify(N):N,M=$.extend(!0,{},{view:{selectedMulti:"true"==n},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1},callback:{onDblClick:i,beforeDrop:l}},waitUserOptions.settting||{}),k=[],x=$.extend(!0,{},{data:{key:{name:"nameLabel"}},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1,drag:{isCopy:!1,isMove:!1}},callback:{onDblClick:f}},hasUserOptions.settting||{}),O=$.extend(!0,{},{url:"",data:{},contentType:"Json"},hasUserOptions.apiCfg||{}),C=hasUserOptions.checkDefaultVal,J=O.contentType||"Json",j=O.data||{};A="Json"==J?JSON.stringify(j):j;window.getCheckValues=function(){var e=y.transformToArray(y.getNodes());if(0==e.length)return Mom.layMsg("请选择用户"),{success:!1,message:"请选择用户"};if(e.length>1&&"true"!=n)return Mom.layMsg("只能选择一个用户"),{success:!1,message:"只能选择一个用户"};if(k.length==e.length){var t=[];$.each(k,function(e,n){t.push(n.id)});for(var r=0,a=0;a<e.length;a++)$.inArray(e[a].id,t)>-1&&r++;if(r==k.length)return{success:!1,oldValues:k,newValues:e,message:"选择的用户没有发生变化"}}return{success:!0,oldValues:k,newValues:e,message:""}},u(!0)})});